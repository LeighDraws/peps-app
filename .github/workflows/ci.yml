name: CI / CD Peps App

# Le WORKFLOW se déclenche sur un push ou PR vers main uniquement
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Définit les jobs à exécuter
jobs:
  # === JOB 1 : BACKEND ===
  backend:
    name: Backend CI
    runs-on: ubuntu-latest

    # Répertoire pour le backend = /api
    defaults:
      run:
        working-directory: ./api

    # Checkout clone le repo dans le runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install JDK 21, setup env variables, build avec Maven
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 21

      # Met en cache le repo Maven pour accélérer les builds
      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # Installe les dépendances Maven
      - name: Install Dependencies
        run: mvn dependency:go-offline -B

      # Lance Spotless pour vérifier le formatage du code
      - name: Run Spotless
        run: mvn -q spotless:check

      # ---- Tests ----
      - name: Run unit tests
        run: mvn test

      # ---- Audit sécurité ----
      # - name: Dependency vulnerability check
      #   run: mvn org.owasp:dependency-check-maven:check -Dformat=ALL

  # === JOB 2 : FRONTEND ===
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    needs: backend # ne build que si le back passe

    # Répertoire pour le front-end = /client
    defaults:
      run:
        working-directory: ./client

    # Checkout clone le repo dans le runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Installe Node.js, dependencies, linter, build Angular
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      # Installe les dépendances
      - name: Install dependencies
        run: npm ci --no-audit

      # Linter
      - name: Run linter
        run: npm run lint

      # Build Angular
      - name: Build Angular app
        run: npm run build

  # === JOB 3 : DOCKER ===
  docker:
    name: Validate Dockerfiles
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Vérifie le Dockerfile backend
      - name: Build backend Docker image
        run: docker build -t peps-backend-test -f ./api/Dockerfile ./api

      # Vérifie le Dockerfile frontend
      - name: Build frontend Docker image
        run: docker build -t peps-frontend-test -f ./client/Dockerfile ./client

  # === NOTIFY JOB ===
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [backend, frontend, docker]
    if: failure() 

    steps:
      # Crée un message d’échec dans les logs
      - name: Message d’échec dans les logs
        run: |
          echo "❌ Le pipeline CI/CD a échoué."
          echo "Vérifie les logs des jobs (backend, frontend ou docker) pour identifier la cause."
          echo "Push pour relancer le pipeline."

      # Commente sur la PR si le workflow a été déclenché par une PR
      - name: Commentaire sur la PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const message = `
            ❌ **CI/CD échouée**
            Le pipeline a échoué sur le commit [${context.sha.slice(0,7)}](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${context.sha}).

            Vérifie les jobs **backend**, **frontend** ou **docker** dans les logs Actions.`;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body: message
            });


  # === DEPLOY ===
  # deploy:
  #   name: Deploy to Render & Vercel
  #   runs-on: ubuntu-latest
  #   needs: [backend, frontend]
  #   if: github.ref == 'refs/heads/main'

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     # --- DEPLOY API ---
  #     - name: Trigger Render deploy
  #       run: |
  #         curl -X POST "$RENDER_DEPLOY_HOOK_URL"
  #       env:
  #         RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}

  #     # --- DEPLOY FRONT ---
  #     - name: Deploy frontend to Vercel
  #       uses: amondnet/vercel-action@v25
  #       with:
  #         vercel-token: ${{ secrets.VERCEL_TOKEN }}
  #         vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
  #         vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
  #         working-directory: ./client
  #         prod: true

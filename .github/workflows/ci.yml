name: CI / CD Peps App

# Le WORKFLOW se déclenche sur un push ou PR vers main uniquement
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Définit les jobs à exécuter
jobs:
  # === JOB 1 : BACKEND BUILD ===
  backend:
    name: Backend CI
    runs-on: ubuntu-latest

    # Répertoire pour le backend = /api
    defaults:
      run:
        working-directory: ./api

    # Checkout clone le repo dans le runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install JDK 21, setup env variables, build avec Maven
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 21

      # Cache le repo Maven pour accélérer les builds
      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # Précharge les dépendances Maven pour un build plus rapide
      - name: Install Dependencies
        run: mvn -DskipTests=true -DskipITs=true dependency:go-offline

      # Lance Spotless pour vérifier le formatage du code
      - name: Run Spotless
        run: mvn -q spotless:check

      # Configure les variables d'environnement pour la connexion à la BDD
      - name: Set up environment variables
        run: |
          echo "DB_URL=${{ secrets.DB_URL }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "SPRING_PROFILES_ACTIVE=prod" >> $GITHUB_ENV

      # Build le backend avec Maven 
      - name: Build backend with Maven
        run: mvn -B -U clean package

  # === FRONTEND BUILD ===
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    needs: backend # ne build que si le back passe

    # Répertoire pour le front-end = /client
    defaults:
      run:
        working-directory: ./client

    # Checkout clone le repo dans le runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Installe Node.js, dependencies, linter, build Angular
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci --no-audit

      - name: Run linter
        run: npm run lint

      - name: Build Angular app
        run: npm run build

  # === DEPLOY ===
  # deploy:
  #   name: Deploy to Render & Vercel
  #   runs-on: ubuntu-latest
  #   needs: [backend, frontend]
  #   if: github.ref == 'refs/heads/main'

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     # --- DEPLOY API ---
  #     - name: Trigger Render deploy
  #       run: |
  #         curl -X POST "$RENDER_DEPLOY_HOOK_URL"
  #       env:
  #         RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}

  #     # --- DEPLOY FRONT ---
  #     - name: Deploy frontend to Vercel
  #       uses: amondnet/vercel-action@v25
  #       with:
  #         vercel-token: ${{ secrets.VERCEL_TOKEN }}
  #         vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
  #         vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
  #         working-directory: ./client
  #         prod: true
